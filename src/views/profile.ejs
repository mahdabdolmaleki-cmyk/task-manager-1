<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="User profile and task management">
    <title>User Profile - Task Manager</title>
    <link rel="stylesheet" href="/styles.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-logo">Task Manager</a>
            <ul class="nav-menu">
                <li><a href="/" class="nav-link">Home</a></li>
                <li><a href="/task/create" class="nav-link">Create Task</a></li>
                <li><a href="/logout" class="nav-link">Logout</a></li>
            </ul>
        </div>
    </nav>

    <!-- Profile Card -->
    <div class="profile-card">
        <div class="profile-header">
            <div class="profile-avatar">
                <%= user.name ? user.name.charAt(0).toUpperCase() : 'U' %>
            </div>
            <div class="profile-info">
                <h1>User Profile</h1>
                <p>Welcome back to your task manager</p>
            </div>
        </div>
        <div class="profile-details">
            <div class="detail-item">
                <span class="detail-label">Name</span>
                <span class="detail-value">
                    <%= user.name %>
                </span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Family</span>
                <span class="detail-value">
                    <%= user.family %>
                </span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Level</span>
                <span class="detail-value">
                    <%= user.level %>
                </span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Email</span>
                <span class="detail-value">
                    <%= user.email %>
                </span>
            </div>
        </div>
    </div>

    <!-- Tasks Section -->
    <div class="tasks-section">
        <div class="section-header">
            <h2 class="section-title">Your Tasks</h2>
            <a href="/task/create" class="create-task-btn">+ Create New Task</a>
        </div>

        <% if (tasks && tasks.length> 0) { %>
            <div class="tasks-grid">
                <% tasks.forEach(function(task) { %>
                    <div class="task-card <%= task.status %> <%= task.urgent ? 'urgent' : '' %>">
                        <div class="task-header">
                            <h3 class="task-title">
                                <%= task.title %>
                            </h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <% if(task.urgent) { %>
                                    <span class="task-badge badge-urgent">Urgent</span>
                                    <% } %>
                                        <span class="task-badge badge-status">
                                            <%= task.status %>
                                        </span>
                            </div>
                        </div>

                        <p class="task-description">
                            <%= task.description %>
                        </p>

                        <div class="task-meta">
                            <div class="task-info">
                                <small style="color: #718096;">ID: <%= task._id.toString().slice(-6) %></small>
                            </div>
                            <div class="task-actions">
                                <button class="btn btn-primary"
                                    onclick="openEditPopup('<%= task._id %>', '<%= task.title %>', '<%= task.status %>')">
                                    Edit Status
                                </button>
                            </div>
                        </div>
                    </div>
                    <% }); %>
            </div>
            <% } else { %>
                <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <h3 class="empty-state-title">No Tasks Yet</h3>
                    <p class="empty-state-text">You don't have any tasks. Create your first task to get started!</p>
                    <a href="/task/create" class="create-task-btn">Create Your First Task</a>
                </div>
                <% } %>
    </div>

    <!-- Edit Popup -->
    <div id="editPopup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header">
                <h3 class="popup-title">Edit Task Status</h3>
            </div>
            <form id="editForm" method="POST">
                <input type="hidden" name="_method" value="PUT">

                <div class="form-group">
                    <label class="form-label" id="taskTitleLabel"></label>
                    <select name="status" class="form-select" id="statusSelect">
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="progress">Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>

                <div class="popup-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeEditPopup()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Popup Management
        function openEditPopup(taskId, taskTitle, currentStatus) {
            const form = document.getElementById('editForm');
            const taskTitleLabel = document.getElementById('taskTitleLabel');
            const statusSelect = document.getElementById('statusSelect');
            const popup = document.getElementById('editPopup');

            // Set form action
            form.action = `/task/${taskId}`;

            // Update form content
            taskTitleLabel.textContent = taskTitle;
            statusSelect.value = currentStatus;

            // Show popup
            popup.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeEditPopup() {
            const popup = document.getElementById('editPopup');
            popup.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Close popup when clicking outside
        document.getElementById('editPopup').addEventListener('click', function (e) {
            if (e.target === this) {
                closeEditPopup();
            }
        });

        // Close popup with ESC key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeEditPopup();
            }
        });

        // Form submission feedback
        document.getElementById('editForm').addEventListener('submit', function (e) {
            // Optional: Add loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;

            // Revert after 3 seconds (in case of error)
            setTimeout(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }, 3000);
        });

        // Status color coding
        document.addEventListener('DOMContentLoaded', function () {
            const statusElements = document.querySelectorAll('.badge-status');
            statusElements.forEach(el => {
                const status = el.textContent.toLowerCase();
                const colorMap = {
                    'pending': '#e2e8f0',
                    'in-progress': '#fed7d7',
                    'progress': '#fed7d7',
                    'completed': '#c6f6d5'
                };
                const textColorMap = {
                    'pending': '#4a5568',
                    'in-progress': '#c53030',
                    'progress': '#c53030',
                    'completed': '#276749'
                };

                if (colorMap[status]) {
                    el.style.backgroundColor = colorMap[status];
                    el.style.color = textColorMap[status];
                }
            });
        });
    </script>
</body>

</html>